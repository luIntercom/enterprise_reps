<!doctype html>
<html>
  <head>
    <title>Fin for SFDC</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      // --- Utility: clear browser state ---
      function clearBrowserState() {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i];
          const eqPos = cookie.indexOf("=");
          const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
          document.cookie =
            name +
            "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;SameSite=Lax";
        }
        window.localStorage.clear();
        window.sessionStorage.clear();
      }

      // --- Random user generators ---
      function randomId() {
        // reasonably unique short id
        return (
          "u_" +
          Math.random().toString(36).slice(2, 10) +
          Date.now().toString(36).slice(-4)
        );
      }

      function randomName() {
        const first = [
          "Alex",
          "Sam",
          "Taylor",
          "Jordan",
          "Riley",
          "Casey",
          "Morgan",
          "Avery",
          "Quinn",
          "Drew",
        ];
        const last = [
          "Hart",
          "Lane",
          "Reed",
          "Shaw",
          "Blake",
          "Wren",
          "Vale",
          "West",
          "Kerr",
          "Hayes",
        ];
        return (
          first[Math.floor(Math.random() * first.length)] +
          " " +
          last[Math.floor(Math.random() * last.length)]
        );
      }

      function generateUser() {
        const id = randomId();
        return {
          user_id: id,
          email: `${id}@example.test`,
          name: randomName(),
        };
      }

      // --- Intercom boot helpers ---
      const APP_ID = "qimjpj9t"; // keep your app id here

      function bootIntercom(user) {
        // If Intercom already booted, shutdown before re-booting with a new identity
        if (typeof window.Intercom === "function") {
          try { window.Intercom("shutdown"); } catch (e) {}
        }

        window.intercomSettings = {
          api_base: "https://api-iam.intercom.io",
          app_id: APP_ID,
          user_id: user.user_id,
          email: user.email,
          name: user.name,
          hand_off_with_javascript: () => {
            // Redirect user to the relative URL
            window.location.href = "./US_SFDC_demo/portal/";
          },
        };

        if (typeof window.Intercom === "function") {
          window.Intercom("boot", window.intercomSettings);
        }
      }

      function assignNewUser() {
        const user = generateUser();
        bootIntercom(user);
        // reflect current identity in the UI
        const badge = document.getElementById("userBadge");
        if (badge) {
          badge.textContent = `${user.name} • ${user.email}`;
        }
      }

      // --- Ticket form helpers ---
      function toggleForm() {
        const form = document.getElementById("ticketForm");
        form.classList.toggle("hidden");
      }

      function submitTicket(e) {
        e.preventDefault();
        const name = document.getElementById("ticketName").value;
        const email = document.getElementById("ticketEmail").value;
        const subject = document.getElementById("ticketSubject").value;
        const message = document.getElementById("ticketMessage").value;

        // For demo: just log form values
        console.log({ name, email, subject, message });
        alert("Ticket submitted successfully!");

        // Reset and hide form
        document.getElementById("ticketForm").reset();
        toggleForm();
      }

      // --- Page lifecycle ---
      window.addEventListener("load", () => {
        // load Intercom widget script (single inclusion)
        (function () {
          const w = window; const d = document;
          const s = d.createElement("script");
          s.type = "text/javascript";
          s.async = true;
          s.src = `https://widget.intercom.io/widget/${APP_ID}`;
          const x = d.getElementsByTagName("script")[0];
          x.parentNode.insertBefore(s, x);
        })();

        // Wait a tick for widget to register, then assign a user and boot
        setTimeout(assignNewUser, 300);
      });

      // Expose actions for buttons
      function hardReset() {
        clearBrowserState();
        // Full page reload (original behavior)
        window.location.reload();
      }

      function userReset() {
        clearBrowserState();
        assignNewUser(); // no reload; generates a fresh identity
      }
    </script>
  </head>

  <body
    class="p-6 flex flex-col flex-1 items-center justify-center min-h-screen bg-cover"
    style="background-image: url('https://downloads.intercomcdn.com/i/o/1051523575/8c16c6bb97ae791131ead20c/blur.jpg')"
  >
    <div class="flex flex-col space-y-3 items-center">
      <img
        src="https://static.intercomassets.com/assets/default-avatars/fin/128-6a5eabbb84cc2b038b2afc6698ca0a974faf7adc9ea9f0fb3c3e78ac12543bc5.png"
        height="50"
        width="50"
        alt="Fin avatar"
      />

      <div
        id="userBadge"
        class="text-sm text-white/90 bg-black/60 px-3 py-1 rounded-full"
      >
        Loading user…
      </div>

      <div class="flex gap-2">
        <button
          class="bg-black text-white px-3 py-2 rounded hover:bg-opacity-75"
          onclick="hardReset()"
        >
          Reset (reload)
        </button>
        <button
          class="bg-indigo-700 text-white px-3 py-2 rounded hover:bg-indigo-600"
          onclick="userReset()"
        >
          User reset
        </button>
        <button
          class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-500"
          onclick="toggleForm()"
        >
          Submit Ticket
        </button>
      </div>
    </div>

    <!-- Hidden Ticket Form -->
    <form id="ticketForm" class="hidden bg-white shadow-md rounded-lg p-6 mt-6 w-80">
      <h2 class="text-lg font-semibold mb-4">Submit a Ticket</h2>
      <input id="ticketName" type="text" placeholder="Your Name" class="w-full border rounded p-2 mb-2" required />
      <input id="ticketEmail" type="email" placeholder="Your Email" class="w-full border rounded p-2 mb-2" required />
      <input id="ticketSubject" type="text" placeholder="Subject" class="w-full border rounded p-2 mb-2" required />
      <textarea id="ticketMessage" placeholder="Message" class="w-full border rounded p-2 mb-4" rows="3" required></textarea>
      <div class="flex justify-between">
        <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" onclick="submitTicket(event)">Submit</button>
        <button type="button" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500" onclick="toggleForm()">Cancel</button>
      </div>
    </form>
  </body>
</html>
